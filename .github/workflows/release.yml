name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          echo "Tag: ${GITHUB_REF_NAME}"
          if ! [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[-0-9A-Za-z]+(\.[-0-9A-Za-z]+)*)?$ ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} does not follow semver format (vx.y.z or vx.y.z-prerelease)"
            exit 1
          fi
          # Reject build metadata in version tags (not allowed in release tags)
          if [[ "${GITHUB_REF_NAME}" == *"+"* ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} contains build metadata (+) which is not allowed in version tags"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build macOS ARM64
        run: cargo build --release --target aarch64-apple-darwin

      - name: Run tests
        run: cargo test --release --target aarch64-apple-darwin

      - name: Verify binary exists
        run: |
          if [ ! -f "target/aarch64-apple-darwin/release/vipune" ]; then
            echo "Error: Binary vipune not found at target/aarch64-apple-darwin/release/vipune"
            exit 1
          fi

      - name: Verify binary architecture
        run: |
          file target/aarch64-apple-darwin/release/vipune

      - name: Validate macOS library dependencies
        run: |
          echo "=== macOS binary dependencies ==="
          file_output=$(file target/aarch64-apple-darwin/release/vipune)
          if [[ "$file_output" != *"Mach-O 64-bit"*executable* ]]; then
            echo "Error: vipune is not an executable: $file_output"
            exit 1
          fi
          otool -L target/aarch64-apple-darwin/release/vipune
          echo "=== Checking for problematic dependencies ==="
          # Check that no unexpected absolute paths are linked
          if otool -L target/aarch64-apple-darwin/release/vipune | grep -qE "(/usr/local|/opt/homebrew)"; then
            echo "Error: Binary has hardcoded Homebrew paths - not portable"
            echo "Binary will fail on systems without Homebrew at these locations"
            otool -L target/aarch64-apple-darwin/release/vipune
            exit 1
          fi

      - name: Validate binary size
        run: |
          size=$(stat -f%z target/aarch64-apple-darwin/release/vipune)
          if [ "$size" -lt 1000000 ]; then
            echo "Error: Binary too small ($size bytes), expected >1MB for Rust release"
            exit 1
          fi
          echo "Binary size: $size bytes"

      - name: Package macOS
        run: |
          cd target/aarch64-apple-darwin/release
          tar czf ../../../vipune-aarch64-apple-darwin.tar.gz vipune
          cd ../../..
          shasum -a 256 vipune-aarch64-apple-darwin.tar.gz > vipune-aarch64-apple-darwin.tar.gz.sha256
          if [ ! -s "vipune-aarch64-apple-darwin.tar.gz.sha256" ]; then
            echo "Error: Checksum file is empty or missing"
            exit 1
          fi
          if ! grep -qE "^[0-9a-f]{64}" vipune-aarch64-apple-darwin.tar.gz.sha256; then
            echo "Error: Checksum file does not contain valid SHA256 hash"
            exit 1
          fi
          # Validate checksum format (hash + two spaces + filename)
          if ! grep -qE "^[0-9a-f]{64}  " vipune-aarch64-apple-darwin.tar.gz.sha256; then
            echo "Error: Checksum file has invalid format (expected: HASH  filename)"
            exit 1
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            vipune-aarch64-apple-darwin.tar.gz
            vipune-aarch64-apple-darwin.tar.gz.sha256

  build-linux:
    name: Build Linux x86_64
    runs-on: ubicloud-standard-4
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          echo "Tag: ${GITHUB_REF_NAME}"
          if ! [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[-0-9A-Za-z]+(\.[-0-9A-Za-z]+)*)?$ ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} does not follow semver format (vx.y.z or vx.y.z-prerelease)"
            exit 1
          fi
          # Reject build metadata in version tags (not allowed in release tags)
          if [[ "${GITHUB_REF_NAME}" == *"+"* ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} contains build metadata (+) which is not allowed in version tags"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build Linux x86_64
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Run tests
        run: cargo test --release --target x86_64-unknown-linux-gnu

      - name: Verify binary exists
        run: |
          if [ ! -f "target/x86_64-unknown-linux-gnu/release/vipune" ]; then
            echo "Error: Binary vipune not found at target/x86_64-unknown-linux-gnu/release/vipune"
            exit 1
          fi

      - name: Verify binary architecture
        run: |
          file target/x86_64-unknown-linux-gnu/release/vipune

      - name: Validate Linux library dependencies
        run: |
          echo "=== Linux binary verification ==="
          file_output=$(file target/x86_64-unknown-linux-gnu/release/vipune)
          if [[ "$file_output" != *"ELF 64-bit LSB"*executable* ]]; then
            echo "Error: vipune is not an executable: $file_output"
            exit 1
          fi
          echo "=== Linux binary dependencies ==="
          if ! ldd target/x86_64-unknown-linux-gnu/release/vipune 2>&1; then
            echo "Warning: ldd failed, may be static binary or corrupted"
            # Continue but flag as warning
          fi
          echo "=== Checking for missing dependencies ==="
          # Check for missing library dependencies
          if ldd target/x86_64-unknown-linux-gnu/release/vipune 2>&1 | grep -q "not found"; then
            echo "Error: Binary has missing library dependencies"
            ldd target/x86_64-unknown-linux-gnu/release/vipune
            exit 1
          fi
          echo "=== Checking for non-standard library paths ==="
          # Check that no non-standard paths are linked
          if ldd target/x86_64-unknown-linux-gnu/release/vipune | grep -qE "(/opt|/usr/local)"; then
            echo "Error: Binary has non-standard library paths - not portable"
            echo "Binary will fail on systems without these paths"
            ldd target/x86_64-unknown-linux-gnu/release/vipune
            exit 1
          fi

      - name: Validate binary size
        run: |
          size=$(stat -c%s target/x86_64-unknown-linux-gnu/release/vipune)
          if [ "$size" -lt 1000000 ]; then
            echo "Error: Binary too small ($size bytes), expected >1MB for Rust release"
            exit 1
          fi
          echo "Binary size: $size bytes"

      - name: Package Linux
        run: |
          cd target/x86_64-unknown-linux-gnu/release
          tar czf ../../../vipune-x86_64-unknown-linux-gnu.tar.gz vipune
          cd ../../..
          sha256sum vipune-x86_64-unknown-linux-gnu.tar.gz > vipune-x86_64-unknown-linux-gnu.tar.gz.sha256
          if [ ! -s "vipune-x86_64-unknown-linux-gnu.tar.gz.sha256" ]; then
            echo "Error: Checksum file is empty or missing"
            exit 1
          fi
          if ! grep -qE "^[0-9a-f]{64}" vipune-x86_64-unknown-linux-gnu.tar.gz.sha256; then
            echo "Error: Checksum file does not contain valid SHA256 hash"
            exit 1
          fi
          # Validate checksum format (hash + two spaces + filename)
          if ! grep -qE "^[0-9a-f]{64}  " vipune-x86_64-unknown-linux-gnu.tar.gz.sha256; then
            echo "Error: Checksum file has invalid format (expected: HASH  filename)"
            exit 1
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: |
            vipune-x86_64-unknown-linux-gnu.tar.gz
            vipune-x86_64-unknown-linux-gnu.tar.gz.sha256

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          echo "Tag: ${GITHUB_REF_NAME}"
          if ! [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[-0-9A-Za-z]+(\.[-0-9A-Za-z]+)*)?$ ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} does not follow semver format (vx.y.z or vx.y.z-prerelease)"
            exit 1
          fi
          # Reject build metadata in version tags (not allowed in release tags)
          if [[ "${GITHUB_REF_NAME}" == *"+"* ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} contains build metadata (+) which is not allowed in version tags"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Build Linux ARM64
        run: cargo build --release --target aarch64-unknown-linux-gnu

      - name: Run tests
        run: cargo test --release --target aarch64-unknown-linux-gnu

      - name: Verify binary exists
        run: |
          if [ ! -f "target/aarch64-unknown-linux-gnu/release/vipune" ]; then
            echo "Error: Binary vipune not found at target/aarch64-unknown-linux-gnu/release/vipune"
            exit 1
          fi

      - name: Verify binary architecture
        run: |
          file target/aarch64-unknown-linux-gnu/release/vipune

      - name: Validate Linux library dependencies
        run: |
          echo "=== Linux ARM64 binary verification ==="
          file_output=$(file target/aarch64-unknown-linux-gnu/release/vipune)
          if [[ "$file_output" != *"ELF 64-bit"*executable* ]]; then
            echo "Error: vipune is not an executable: $file_output"
            exit 1
          fi
          # Verify this is actually an ARM64 binary, not x86_64
          if ! ( echo "$file_output" | grep -qE "aarch64|arm64" ); then
            echo "Error: vipune is not an ARM64 executable: $file_output"
            echo "Binary appears to be wrong architecture (expected aarch64/arm64)"
            exit 1
          fi
          echo "=== Linux binary dependencies ==="
          if ! ldd target/aarch64-unknown-linux-gnu/release/vipune 2>&1; then
            echo "Warning: ldd failed, may be static binary or corrupted"
            # Continue but flag as warning
          fi
          echo "=== Checking for missing dependencies ==="
          # Check for missing library dependencies
          if ldd target/aarch64-unknown-linux-gnu/release/vipune 2>&1 | grep -q "not found"; then
            echo "Error: Binary has missing library dependencies"
            ldd target/aarch64-unknown-linux-gnu/release/vipune
            exit 1
          fi
          echo "=== Checking for non-standard library paths ==="
          # Check that no non-standard paths are linked
          if ldd target/aarch64-unknown-linux-gnu/release/vipune | grep -qE "(/opt|/usr/local)"; then
            echo "Error: Binary has non-standard library paths - not portable"
            echo "Binary will fail on systems without these paths"
            ldd target/aarch64-unknown-linux-gnu/release/vipune
            exit 1
          fi

      - name: Validate binary size
        run: |
          size=$(stat -c%s target/aarch64-unknown-linux-gnu/release/vipune)
          if [ "$size" -lt 1000000 ]; then
            echo "Error: Binary too small ($size bytes), expected >1MB for Rust release"
            exit 1
          fi
          echo "Binary size: $size bytes"

      - name: Package Linux ARM64
        run: |
          cd target/aarch64-unknown-linux-gnu/release
          tar czf ../../../vipune-aarch64-unknown-linux-gnu.tar.gz vipune
          cd ../../..
          sha256sum vipune-aarch64-unknown-linux-gnu.tar.gz > vipune-aarch64-unknown-linux-gnu.tar.gz.sha256
          if [ ! -s "vipune-aarch64-unknown-linux-gnu.tar.gz.sha256" ]; then
            echo "Error: Checksum file is empty or missing"
            exit 1
          fi
          if ! grep -qE "^[0-9a-f]{64}" vipune-aarch64-unknown-linux-gnu.tar.gz.sha256; then
            echo "Error: Checksum file does not contain valid SHA256 hash"
            exit 1
          fi
          # Validate checksum format (hash + two spaces + filename)
          if ! grep -qE "^[0-9a-f]{64}  " vipune-aarch64-unknown-linux-gnu.tar.gz.sha256; then
            echo "Error: Checksum file has invalid format (expected: HASH  filename)"
            exit 1
          fi

      - name: Upload Linux ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: |
            vipune-aarch64-unknown-linux-gnu.tar.gz
            vipune-aarch64-unknown-linux-gnu.tar.gz.sha256

  release:
    name: Create GitHub Release
    needs: [build-macos, build-linux, build-linux-arm64]
    runs-on: ubicloud-standard-4
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect prerelease
        id: prerelease_check
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[-0-9A-Za-z]+(\.[-0-9A-Za-z]+)*) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Validate artifact count
        run: |
          expected_files=6
          actual_files=$(find artifacts \( -name "*.tar.gz" -o -name "*.sha256" \) | wc -l)
          echo "Expected $expected_files artifacts, found $actual_files"
          if [ "$actual_files" -ne "$expected_files" ]; then
            echo "Error: Expected $expected_files artifacts, found $actual_files"
            echo "=== Downloaded files ==="
            find artifacts \( -name "*.tar.gz" -o -name "*.sha256" \)
            exit 1
          fi
          echo "✅ All expected artifacts downloaded"

      - name: Detect artifact name collisions
        run: |
          echo "=== Checking for filename collisions ==="
          find artifacts \( -name "*.tar.gz" -o -name "*.sha256" \) -printf "%f\n" | sort | uniq -d > duplicates.txt
          if [ -s duplicates.txt ]; then
            echo "Error: Found duplicate artifact names (collision risk):"
            cat duplicates.txt
            exit 1
          fi
          echo "✅ No filename collisions detected"
          rm -f duplicates.txt

      - name: Move artifacts to root for release
        run: |
          find artifacts -name "*.tar.gz" -exec cp {} . \;
          find artifacts -name "*.sha256" -exec cp {} . \;
          echo "=== Files ready for release ==="
          ls -la *.tar.gz *.sha256

      - name: Validate all artifacts exist
        run: |
          echo "=== Validating expected artifacts ==="

          # Define expected artifacts
          expected_artifacts=(
            "vipune-aarch64-apple-darwin.tar.gz"
            "vipune-aarch64-apple-darwin.tar.gz.sha256"
            "vipune-x86_64-unknown-linux-gnu.tar.gz"
            "vipune-x86_64-unknown-linux-gnu.tar.gz.sha256"
            "vipune-aarch64-unknown-linux-gnu.tar.gz"
            "vipune-aarch64-unknown-linux-gnu.tar.gz.sha256"
          )

          # Check each expected artifact exists
          for artifact in "${expected_artifacts[@]}"; do
            if [ ! -f "$artifact" ]; then
              echo "Error: Missing artifact: $artifact"
              echo "=== Available artifacts ==="
              ls -la *.tar.gz *.sha256
              exit 1
            fi
            echo "✅ Found: $artifact"
          done

          # Count total artifacts
          total_targz=$(ls -1 *.tar.gz 2>/dev/null | wc -l)
          total_sha256=$(ls -1 *.sha256 2>/dev/null | wc -l)
          echo "=== Summary ==="
          echo "Found $total_targz tar.gz and $total_sha256 sha256 files (expected 3 each)"
          echo "All expected artifacts validated successfully"

      - name: Verify checksums
        run: |
          for sha_file in *.sha256; do
            # Validate filename is safe (no path traversal)
            if [[ "$sha_file" =~ ^[./] ]] || [[ "$sha_file" =~ \.\/ ]] || [[ "$sha_file" =~ \.\.\/ ]]; then
              echo "Error: Unsafe filename detected: $sha_file"
              exit 1
            fi
            tar_file="${sha_file%.sha256}"
            if [ ! -f "$tar_file" ]; then
              echo "Error: Checksum file exists but tarball missing: $sha_file"
              exit 1
            fi
            # Extract the checksum line for our specific tarball (first match only)
            checksum_line=$(grep -P "^\S+\s+$(basename "$tar_file")$" "$sha_file" | head -n 1)
            if [ -z "$checksum_line" ]; then
              echo "Error: Checksum file doesn't contain hash for tarball: $tar_file"
              exit 1
            fi
            # Create a temporary checksum file with just our entry (secure mktemp)
            tmp_file=$(mktemp) || exit 1
            echo "$checksum_line" > "$tmp_file"
            echo "Verifying checksum for $tar_file"
            if ! sha256sum -c "$tmp_file" > /dev/null 2>&1; then
              echo "Error: Checksum verification failed for $tar_file"
              rm -f "$tmp_file"
              exit 1
            fi
            rm -f "$tmp_file"
            echo "✅ Checksum valid for $tar_file"
          done

      - name: Create GitHub Release with auto-generated notes
        run: |
          echo "=== Validating files for release ==="
          # Define expected artifacts
          expected_artifacts=(
            "vipune-aarch64-apple-darwin.tar.gz"
            "vipune-aarch64-apple-darwin.tar.gz.sha256"
            "vipune-x86_64-unknown-linux-gnu.tar.gz"
            "vipune-x86_64-unknown-linux-gnu.tar.gz.sha256"
            "vipune-aarch64-unknown-linux-gnu.tar.gz"
            "vipune-aarch64-unknown-linux-gnu.tar.gz.sha256"
          )
          for artifact in "${expected_artifacts[@]}"; do
            if [ ! -f "$artifact" ]; then
              echo "Error: Artifact not found: $artifact"
              exit 1
            fi
            echo "✅ Found: $artifact"
          done
          PRERELEASE_FLAG=""
          if [[ "${{ steps.prerelease_check.outputs.is_prerelease }}" == "true" ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          gh release create "${GITHUB_REF_NAME}" \
            --title "${GITHUB_REF_NAME}" \
            $PRERELEASE_FLAG \
            --generate-notes \
            vipune-aarch64-apple-darwin.tar.gz \
            vipune-aarch64-apple-darwin.tar.gz.sha256 \
            vipune-x86_64-unknown-linux-gnu.tar.gz \
            vipune-x86_64-unknown-linux-gnu.tar.gz.sha256 \
            vipune-aarch64-unknown-linux-gnu.tar.gz \
            vipune-aarch64-unknown-linux-gnu.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
