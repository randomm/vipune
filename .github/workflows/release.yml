name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubicloud-standard-4
            target: aarch64-apple-darwin
            name: macos-arm64
          - os: ubicloud-standard-4
            target: x86_64-unknown-linux-gnu
            name: linux-x86_64
          # Temporarily disabled for v0.1.0: Linux ARM64 cross-compilation requires OpenSSL support
          # Re-enable in v0.2.0 after investigating ort crate aarch64-unknown-linux-gnu support
          # - os: ubuntu-latest
          #   target: aarch64-unknown-linux-gnu
          #   name: linux-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          echo "Tag: ${GITHUB_REF_NAME}"
          if ! [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "Error: Tag ${GITHUB_REF_NAME} does not follow semver format (vx.y.z or vx.y.z-prerelease)"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Run tests
        run: cargo test --release --target ${{ matrix.target }}

      - name: Verify binary exists
        run: |
          if [ ! -f "target/${{ matrix.target }}/release/vipune" ]; then
            echo "Error: Binary vipune not found at target/${{ matrix.target }}/release/vipune"
            exit 1
          fi

      - name: Verify binary architecture
        run: |
          file target/${{ matrix.target }}/release/vipune

      - name: Validate library dependencies
        run: |
          if [ "$(uname)" = "Darwin" ]; then
            echo "=== macOS binary dependencies ==="
            otool -L target/${{ matrix.target }}/release/vipune || true
            echo "=== Checking for problematic dependencies ==="
            # Check that no unexpected absolute paths are linked
            if otool -L target/${{ matrix.target }}/release/vipune | grep -qE "(/usr/local|/opt/homebrew)"; then
              echo "Error: Binary has hardcoded Homebrew paths - not portable"
              echo "Binary will fail on systems without Homebrew at these locations"
              otool -L target/${{ matrix.target }}/release/vipune
              exit 1
            fi
          else
            echo "=== Linux binary dependencies ==="
            ldd target/${{ matrix.target }}/release/vipune || true
            echo "=== Checking for missing dependencies ==="
            # Check for missing library dependencies
            if ldd target/${{ matrix.target }}/release/vipune 2>&1 | grep -q "not found"; then
              echo "Error: Binary has missing library dependencies"
              ldd target/${{ matrix.target }}/release/vipune
              exit 1
            fi
          fi

      - name: Validate binary size
        run: |
          if [ "$(uname)" = "Darwin" ]; then
            size=$(stat -f%z target/${{ matrix.target }}/release/vipune)
          else
            size=$(stat -c%s target/${{ matrix.target }}/release/vipune)
          fi
          if [ "$size" -lt 100 ]; then
            echo "Error: Binary too small ($size bytes), likely corrupted"
            exit 1
          fi
          echo "Binary size: $size bytes"

      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../vipune-${{ matrix.target }}.tar.gz vipune
          cd ../../..
          if [ "$(uname)" = "Darwin" ]; then
            shasum -a 256 vipune-${{ matrix.target }}.tar.gz > vipune-${{ matrix.target }}.tar.gz.sha256
          else
            sha256sum vipune-${{ matrix.target }}.tar.gz > vipune-${{ matrix.target }}.tar.gz.sha256
          fi
          if [ ! -s "vipune-${{ matrix.target }}.tar.gz.sha256" ]; then
            echo "Error: Checksum file is empty or missing"
            exit 1
          fi
          if ! grep -qE "^[0-9a-f]{64}" vipune-${{ matrix.target }}.tar.gz.sha256; then
            echo "Error: Checksum file does not contain valid SHA256 hash"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vipune-${{ matrix.target }}
          path: |
            vipune-${{ matrix.target }}.tar.gz
            vipune-${{ matrix.target }}.tar.gz.sha256

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubicloud-standard-4
    permissions:
      contents: write
    steps:
      - name: Detect prerelease
        id: prerelease_check
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded files ==="
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \)

      - name: Validate all artifacts exist
        run: |
          echo "=== Validating expected artifacts ==="
          
          # Define expected artifacts
          expected_artifacts=(
            "vipune-aarch64-apple-darwin.tar.gz"
            "vipune-aarch64-apple-darwin.tar.gz.sha256"
            "vipune-x86_64-unknown-linux-gnu.tar.gz"
            "vipune-x86_64-unknown-linux-gnu.tar.gz.sha256"
          )
          
          # Check each expected artifact exists
          for artifact in "${expected_artifacts[@]}"; do
            if ! find artifacts -name "$artifact" | grep -q .; then
              echo "Error: Missing artifact: $artifact"
              echo "=== Available artifacts ==="
              find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \)
              exit 1
            fi
            echo "âœ… Found: $artifact"
          done
          
          # Count total artifacts
          total_targz=$(find artifacts -name "*.tar.gz" | wc -l)
          total_sha256=$(find artifacts -name "*.sha256" | wc -l)
          echo "=== Summary ==="
          echo "Found $total_targz tar.gz and $total_sha256 sha256 files (expected 2 each)"
          echo "All expected artifacts validated successfully"

      - name: Create GitHub Release with auto-generated notes
        run: |
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \) | sort > artifact-files.txt
          echo "Attaching files to release:"
          cat artifact-files.txt
          FILES=$(cat artifact-files.txt | sed 's/^/--attach /' | tr '\n' ' ')
          if [ -z "$FILES" ]; then
            echo "Error: No artifacts to attach"
            exit 1
          fi
          while IFS= read -r file; do
            if [ ! -f "$file" ]; then
              echo "Error: Artifact file not found: $file"
              exit 1
            fi
          done < artifact-files.txt
          gh release create "${GITHUB_REF_NAME}" \
            --prerelease ${{ steps.prerelease_check.outputs.is_prerelease }} \
            --generate-notes \
            $FILES
          rm artifact-files.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
